# This workflow will prepare a PR that pulls in the latest changes from the
# Bullet Train starter repo.
name: "Create Bullet Train Update PR"
on:
  workflow_call:
  workflow_dispatch:
    inputs:
      versionNumber:
        description: 'Version Number'
        required: true
        type: string

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # We have to fetch the full history so that the merge step will understand
          # how to properly merge the starter repo with our local changes.
          fetch-depth: 0

      # TODO: It would be nice to be able to set this to be the username & email of the user who
      # triggered this action. Unfortuately GitHub doesn't make the email address available.
      - name: Set git config
        run: |
          git config user.name ${{ github.actor }}
          git config user.email ${{ github.actor }}@users.noreply.github.com

      - name: Setup Ruby
        uses: "ruby/setup-ruby@v1"
        with:
          bundler-cache: true
          ruby-version: 3.2

      - name: Add Bullet Train Starter Repo git remote
        run: git remote add bullet-train https://github.com/bullet-train-co/bullet_train.git

      - name: Fetch Bullet Train Starter Repo
        run: git fetch --tags bullet-train

      - name: Merge version tag
        run: git merge v${{ inputs.versionNumber }} -s ort -X theirs

      - name: Config bundler
        # We have to do this so that a subsequent `bundle install` will work without complaining
        # that we have changed Gemfile.lock in a deployment context.
        run: bundle config unset deployment

      - name: Bundle install
        # We do this to try to avoid clobbering bits of `Gemfile.lock` that may have gotten discarded
        # during the merge since we're favoring the Starter Repo.
        run: bundle install

      - name: Remove vendor/bundle
        # This is an artifact of installing the gems, and we don't want to add it to the PR.
        run: rm -rf vendor/bundle

      - name: "Create Pull Request"
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          # We use a different token so that the PR that gets created will auto-trigger additional
          # workflows. The normal token is prevented from triggering other workflows. If you don't
          # have additional workflows that you want to trigger you can comment out this next line.
          token: ${{ secrets.PAT }}
          author: "${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>"
          committer: "${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>"
          commit-message: "Bullet Train Update: ${{ inputs.versionNumber }}"
          branch: "bullet-train-update/${{ inputs.versionNumber }}"
          delete-branch: true
          title: "Bullet Train Update: ${{ inputs.versionNumber }}"
          add-paths: "."
          body: |
            Update of the Bullet Train Starter Repo to version `${{ inputs.versionNumber }}`

            **Please note:** You should thorougly review this PR. In order to generate this PR we resolve any conflicts in favor of the Starter Repo. This means that this PR might overwrite some changes that you've made.

            - Auto-generated by `.github/workflows/update-bullet-train.yml`

          #labels: |
            #core bump
