#!/usr/bin/env bash

export SPRING=true

if [ -z "${CIRCLE_NODE_INDEX}" ] || [ "${CIRCLE_NODE_INDEX}" == "0" ]; then
  bundle exec spring rails g model Project team:references name:string
  bin/super-scaffold crud Project Team name:text_field --sidebar="ti.ti-world"
  bin/super-scaffold action-model:targets-many Archive Project Team

  # Set up the action we want to test.
  PERFORM_METHOD="  def perform_on_target(project)"
  TARGETS_MANY_ACTION='project.update(name: "#{project.name} + archived")'
  PERFORM_METHOD_WITH_CONTENT="  def perform_on_target(project)\n    ${TARGETS_MANY_ACTION}"
  sed -i "s/${ACTION_METHOD}/${ACTION_METHOD_WITH_CONTENT}/g" app/models/projects/archive_action.rb
else
  echo "Skipping the \`targets-many\` action on this CI node."
fi
